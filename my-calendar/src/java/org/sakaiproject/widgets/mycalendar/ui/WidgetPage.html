<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wicket="http://wicket.apache.org/dtds.data/wicket-xhtml1.4-strict.dtd" >
 
<head>
	<title><wicket:message key="app.title" /></title>
</head>     
<body>

<!-- TODO may need a way to namespace all of this, aka uPortal style? For now just look it up and assume one per page -->

<div class="my-calendar"></div>
<h3 class="my-calendar-event-heading"></h3>


<script type='text/javascript' src='http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.js'></script>
<script class="my-calendar-event-template" type="text/x-jquery-tmpl">
	<li class="my-calendar-event"> ${eventType}: {{if url}} <a href="${url}" target="_top">${eventTitle}</a> {{else}} ${eventTitle} {{/if}} </li>
</script>
<div class="my-calendar-events" />

<!-- Wicket loads some pieces of data into this container which can be looked up by the Javascript -->
<div class="my-calendar-data" wicket:id="data">This holds data</div>

<script type="text/javascript">

var siteId;
$(document).ready(function() {
	siteId = $(".my-calendar-data").attr("data-siteid");
	timeZone = $(".my-calendar-data").attr("data-tz");
	jQuery.ajax({
	    url: '/direct/calendar/site/' + siteId + '.json',
	    success: function (result) {
	        eventList = result.calendar_collection;
	    },
	    async: false
	});
	
	$(".my-calendar").datepicker({
	    beforeShowDay: function(date) {
	    	var numEvents = getEventsForDate(date);
			if (numEvents > 0) {
	            return [true, "my-calendar-eventful-day", numEvents + (numEvents > 1 ? " events" : " event")];
	        }
	        else {
	            return [true, '', ''];
	        } 
	    },
	     onSelect: function(date) {
	    	 formattedDate = date.substring(6,10) + "-" + date.substring(0,2) + "-" + date.substring(3,5);
	    	 
	    	 jQuery.ajax({
	    		    url: "/direct/calendar/site/" + siteId + ".json?firstDate=" + formattedDate + "&lastDate=" + formattedDate,
	    		    success: function (result) {
	    		        events = result.calendar_collection;
	    		    },
	    		    async: false
	    		}); 
	    	 
	    	 if (events.length > 0) {
	    		 $(".my-calendar-events").text("");
	    		 $(".my-calendar-event-heading").text("Events for " + moment(formattedDate).format("MMM DD, YYYY"));
				 var eventsDisplay = [];
	    		 for (i = 0; i < events.length; i++) {
	    			 if (events[i].assignmentId.length > 0) {
	    				 jQuery.ajax({
    		    		    url: "/direct/assignment/deepLink/" + siteId + "/" + events[i].assignmentId + ".json",
    		    		    success: function (result) {
    		    		        assignmentUrl = result.data.assignmentUrl;
    		    		    },
    		    		    async: false
	    		    	}); 
	    				 
	    				eventsDisplay.push({eventType: events[i].type, eventTitle: events[i].title, url: assignmentUrl});
	    			 }
	    			 else {
	    				eventsDisplay.push({eventType: events[i].type, eventTitle: events[i].title});
	    			 }
	    		 }
		    	 $(".my-calendar-event-template").tmpl(eventsDisplay).appendTo(".my-calendar-events");
	    	 } 
	    	 else {
	    		 $(".my-calendar-event-heading").text("");
	    		 $(".my-calendar-events").text("");
	    	 }
	    	 setMainFrameHeightNow(window.name, -1);
	    	
	    },
	    onChangeMonthYear: function() {
	    	$(".my-calendar-events").text("");
	    	$(".my-calendar-event-heading").text("");
	    },
	    // config
	    showOtherMonths: true
	});
});

function getEventsForDate(date) {
	var numEvents = 0;
	for (i = 0; i < eventList.length; i++) {
		eventDate = moment(eventList[i].firstTime.time).tz(timeZone);
		if (eventDate.isSame(moment(date), "day")) {
			numEvents += 1;
		}
	}
	return numEvents;
}

</script>

</body>
</html>