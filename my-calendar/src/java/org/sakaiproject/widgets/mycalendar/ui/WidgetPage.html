<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wicket="http://wicket.apache.org/dtds.data/wicket-xhtml1.4-strict.dtd" >
 
<head>
	<title><wicket:message key="app.title" /></title>
</head>     
<body>

<!-- TODO may need a way to namespace all of this, aka uPortal style. By adding an element to the data div for namespace. For now just look it up and assume one per page -->

<!-- data container, added as data- attributes -->
<div class="my-calendar-data" wicket:id="data" />

<!--  layout -->
<div class="my-calendar"></div>
<h3 class="my-calendar-event-heading"></h3>
<div class="my-calendar-events"></div>

<!--  templates -->
<script id="my-calendar-event-template" type="text/x-jsrender">
	<li class="my-calendar-event"> {{:eventType}}: {{if url}} <a href="{{:url}}" target="_top">{{:eventTitle}}</a> {{else}} {{:eventTitle}} {{/if}} </li>
</script>

<script id="my-calendar-heading-template" type="text/x-jsrender">
	<h3>
		<i class="fa fa-arrow-circle-o-left fa-lg" aria-hidden="true"></i>
		{{:heading}}
		<i class="fa fa-arrow-circle-o-right fa-lg" aria-hidden="true"></i>
	</h3>
</script>


<script type="text/javascript">

var siteId;
var timeZone;
var eventsList = [];

$(document).ready(function() {
	
	// data
	siteId = $(".my-calendar-data").attr("data-siteid");
	timeZone = $(".my-calendar-data").attr("data-tz");
	
	// i18n
	jQuery.i18n.properties({
	    name:'Messages', 
	    path:'/my-calendar/bundle/',
	    mode: 'both',
	    cache: true
	});
	
	//get all events for the site
	eventList = getEvents();
	
	$(".my-calendar").datepicker({
		beforeShowDay: function(date) {
	    	var numEvents = countEvents(date);
			if (numEvents > 0) {
	            return [true, "my-calendar-eventful-day", numEvents + (numEvents > 1 ? " events" : " event")];
	        }
	        else {
	            return [true, '', ''];
	        } 
	    },
		onSelect: function(date) {
						
			// format the date
			var formattedDate = getISO8601Date(date);
			
			// set heading
			var headingTmpl = $.templates("#my-calendar-heading-template");
			var headingText = {"heading": jQuery.i18n.prop('event_heading', moment(formattedDate).format("MMM DD, YYYY"))};
			var headingHtml = headingTmpl.render(headingText);
			$(".my-calendar-event-heading").html(headingHtml);
			
			// show the events
			var selectedDayEvents = getEvents(formattedDate);
			if (selectedDayEvents.length > 0) {
				$(".my-calendar-events").text("");
				var eventsDisplay = getEventsDisplay(selectedDayEvents);
				
				var template = $.templates("#my-calendar-event-template");
				var rendered = template.render(eventsDisplay);
				$(".my-calendar-events").html(rendered);
				
			} else {
	    		 $(".my-calendar-events").text(jQuery.i18n.prop('no_events'));
			}
			
			setMainFrameHeightNow(window.name, -1);
	    	
	    },
	    onChangeMonthYear: function() {
	    	$(".my-calendar-events").text("");
	    	$(".my-calendar-event-heading").text("");
	    },
	    // config
	    showOtherMonths: true
	});
	
	//show heading and events for initial day
	//TODO this can be combined
	var todaysEvents = getEvents(moment().format('YYYY-MM-DD'));
	var eventsDisplay = getEventsDisplay(todaysEvents);
	
	var headingTmpl = $.templates("#my-calendar-heading-template");
	var headingText = {"heading": jQuery.i18n.prop('event_heading_today')};
	var headingHtml = headingTmpl.render(headingText);
	$(".my-calendar-event-heading").html(headingHtml);
	
	if (todaysEvents.length > 0) {
		$(".my-calendar-events").text("");
		
		var eventsDisplay = getEventsDisplay(todaysEvents);
		var eventTmpl = $.templates("#my-calendar-event-template");
		var eventHtml = eventTmpl.render(eventsDisplay);
		$(".my-calendar-events").html(eventHtml);
	} else {
		$(".my-calendar-events").text(jQuery.i18n.prop('no_events'));
	}
});

/**
 * Parse the event list and count the number of events that match the date
 * @param date from the datepicker, is in the format mm/dd/yyyy
 */
function countEvents(date) {
	var numEvents = 0;
	for (i = 0; i < eventList.length; i++) {
		eventDate = moment(eventList[i].firstTime.time).tz(timeZone);
		if (eventDate.isSame(moment(date), "day")) {
			numEvents += 1;
		}
	}
	return numEvents;
}

/**
 * Format a date into YYYY-MM-DD format.
 * @param date from the datepicker, is in the format mm/dd/yyyy so we need to pick out the parts
 */
function getISO8601Date(date) {
	return date.substring(6,10) + "-" + date.substring(0,2) + "-" + date.substring(3,5); //get date in YYYY-MM-DD
}


/**
 * Get events for a given date in ISO8601 format 
 * @param date YYYY-MM-DD format
 */
function getEvents(date) {
	 
	var url = "/direct/calendar/site/" + siteId + ".json";
	if(date) {
		url += "?firstDate=" + date + "&lastDate=" + date;
	}
 	 
	jQuery.ajax({
		url: url,
		success: function (result) {
			//TODO declare this
			events = result.calendar_collection;
		},
		async: false
	});
	
	return events;
}

/**
 * Helper to turn a list of events into the display array ready for rendering by the template
 * @param events array of events
 *
 * TODO this could be combined with getEvents?
 */
function getEventsDisplay(events) {
	var eventsDisplay = [];
	for (i = 0; i < events.length; i++) {
		if (events[i].assignmentId.length > 0) {
			jQuery.ajax({
				url: "/direct/assignment/deepLink/" + siteId + "/" + events[i].assignmentId + ".json",
				success: function (result) {
				assignmentUrl = result.data.assignmentUrl;
			},
			async: false
			}); 

			eventsDisplay.push({"eventType": events[i].type, "eventTitle": events[i].title, "url": assignmentUrl});
		}
		else {
			eventsDisplay.push({"eventType": events[i].type, "eventTitle": events[i].title});
		}
	}
	
	return eventsDisplay;
}

</script>

</body>
</html>